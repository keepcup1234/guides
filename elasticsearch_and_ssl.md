# Setup of encrypted communication in Elastic Stack with Basic license

## Content

* [Test-elk-master01 config](#test-elk-master01-config)
* [Test-elk-data01 config](#test-elk-data01-config)
* [Test-elk-kibana01 config](#test-elk-kibana01-config)
* [Test-elk-logstash01 config](#test-elk-logstash01-config)
* [Test-elk-filebeat01 config](#test-elk-filebeat01-config)

## Setup

Several nodes running on CentOS7:

* test-elk-master01 - node that will act as master in the cluster
* test-elk-data01 - data node
* test-elk-kibana01 - kibana node
* test-elk-logstash01 - logstash node
* test-elk-filebeat01 - node with filebeat installed and sending logs to logstash

What we want to achieve is to have encrypted communication between each node with self signed certificates that are generated by elasticsearch tool.

## Common configuration for all ELK nodes

1. Add elastic repo, edit **/etc/yum.repos.d/elastic.repo** :

```
[elasticsearch] 
name=Elasticsearch repository for 7.x packages 
baseurl=https://artifacts.elastic.co/packages/7.x/yum 
gpgcheck=1 
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch 
enabled=1 
autorefresh=1 
type=rpm-md
```

2. Install required packages : **yum install java-1.8.0-openjdk** , also install package based on node - *elasticsearch/kibana/logstash/filebeat*

## test-elk-master01 config

1. On this node install *elasticsearch* package
2. Certificates that will be used in cluster, will be generated on master01 and distributed accross the cluster. Go to **/usr/share/elasticsearch/bin**
3. Generate CA - `./elasticsearch-cert ca` , certificate will be stored in one folder above, leaving name of cert default
4. Generate p12 certificate for each node, in this case will be master01 node - `./elasticsearch-certutil --name test-elk-master01 --ca elastic-stack-ca.p12` . No password for cert. Copy the cert file to **/etc/elasticsearch**
5. Generate built in users - `./elasticsearch-setup-passwords auto` This will generate list of random passwords for built in users. **!!Save the list!!**
6. Generate cert for communication with Kibana - `./elasticsearch-certutil http` Follow the steps. When you prompt for hostname and ip address , use hostname and ip address of master01. Unzip the archive and copy *http.p12* to **/etc/elasticsearch**
7. Edit **/etc/elasticsearch/elasticsearch.yml** file

```
cluster.name: test01
node.name: test-elk-master01
node.master: true
node.data: false
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: [local ip address]
http.port: 9200
discovery.seed_hosts: ["test-elk-master01"]
cluster.initial_master_nodes: ["test-elk-master01"]
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: test-elk-master01.p12
xpack.security.transport.ssl.truststore.path: test-elk-master01.p12
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: "http.p12"
```
[Back to content list](#content)

## test-elk-data01 config

1. On this node insalll *elasticsearch* package
2. Generate p12 certificate on master01 node, in this case will be data01 node - `./elasticsearch-certutil --name test-elk-data01 --ca elastic-stack-ca.p12` . No password for cert. Copy the cert file from master01 to data01 **/etc/elasticsearch**
3. Edit **/etc/elasticsearch/elasticsearch.yml** file

```
cluster.name: test01
node.name: test-elk-data01
node.master: false
node.data: true
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: [local ip address]
http.port: 9200
discovery.seed_hosts: ["test-elk-master01"]
cluster.initial_master_nodes: ["test-elk-master01"]
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: test-elk-data01.p12
xpack.security.transport.ssl.truststore.path: test-elk-data01.p12
```

[Back to content list](#content)

## test-elk-kibana01 config

1. On this node install *kibana* package
2. Get certificate bundle from master01 that was generated in step 6. This bundle contains files for master01 as well as for kibana01. It contains CA public certificate
3. Generate self certificate for web insterface. For testing purposes i made self signed certificates : `openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout kibana-web.key -out kibana-web.crt`
4. Edit file **/etc/kibana/kibana.yml**:
```
server.port: 5601
server.host: "[ local ip ]"
server.name: "test-elk-kibana01"
elasticsearch.hosts: ["https://test-elk-master01:9200"]
elasticsearch.ssl.certificateAuthorities: [ "/etc/kibana/elasticsearch-ca.pem" ]
server.ssl.certificate: "/etc/kibana/kibana-web.crt"
server.ssl.key: "/etc/kibana/kibana-web.key"
server.ssl.enabled: true
elasticsearch.username: "kibana_system"
elasticsearch.password: "some password"
```
The *elasticsearch.username* and *elasticsearch.password* was generated on master01 in step 5. 
5. Start kibana service and access web **https://test-elk-kibana01:5601** . Then login as user *elastics* ( password is from step 5. on master01 ) , then create your own user

Now we have basic ELK cluster working

[Back to content list](#content)

## test-elk-logstash01 config

1. On this node installl *logstash* package
2. Generate p12 certificate on master01 node, in this case will be logstash01 node - `./elasticsearch-certutil --name test-elk-logstash01 --ca elastic-stack-ca.p12 --pem` . No password for cert. This will create .zip file with private and public certificate, Copy the zip file from master01 to logstash01, then unzip. Also copy CA certificate from master01. I made */etc/logstash/cert/* dir to keep all certificates on one place
3. Now we need to convert *test-elk-logstash01.key* key to pkcs8 format : `openssl pkcs8 -in test-elk-logstash01.key -topk8 -out test-elk-logstash01-8.key -nocrypt`
4. Now, create basic config that will have just input and output filter. Edit **/etc/logstash/conf.d/test.conf**
```
input {
	beats {
		port => 5044
		ssl => true
		ssl_certificate_authorities => [ "/etc/logstash/cert/elasticsearch-ca.pem" ]
		ssl_certificate => "/etc/logstash/cert/test-elk-logstash01.crt"
		ssl_key => "/etc/logstash/cert/test-elk-logstash01-8.key"
		ssl_verify_mode => "force_peer"
	}
}

output {
	elasticsearch {
		hosts => ["test-elk-master01:9200"]
		index => "filebeat-%{+YYYY.MM.dd}"
		ssl => true
		cacert => "/etc/logstash/cert/elasticsearch-ca.pem"
		user => "elastic"
		password => "password"
	}
}
```
So we will listen on port 5044 and expecting input from Beats. Filebeat will also use TLS connestion. Output goes to our master01 and we will use user *elastic* for that ( password from step 5. on master01 )

[Back to content list](#content)

## test-elk-filebeat01 config ##

1. On this node install *filebeat* package
2.  Generate p12 certificate on master01 node, in this case will be filebeat01 node - `./elasticsearch-certutil --name test-elk-filebeat01 --ca elastic-stack-ca.p12 --pem` . No password for cert. This will create .zip file with private and public certificate, Copy the zip file from master01 to filebeat01, then unzip. Also copy CA certificate from master01. I made */etc/filebeat/cert/* dir to keep all certificates on one place
3.  Now we need to convert *test-elk-filebeat01.key* key to pkcs8 format : `openssl pkcs8 -in test-elk-filebeat01.key -topk8 -out test-elk-filebeat01-8.key -nocrypt`
4.  As we are going to send system logs, we need to enable module : `filebeat modules enable system`
5.  Edit **/etc/filebeat/filebeat.yml**
```
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/messages
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false
setup.template.settings:
  index.number_of_shards: 1
output.logstash:
  hosts: ["test-elk-logstash01:5044"]
  ssl.certificate_authorities: ["/etc/filebeat/cert/elasticsearch-ca.pem"]
  ssl.certificate: "/etc/filebeat/cert/test-elk-filebeat01.crt"
  ssl.key: "/etc/filebeat/cert/test-elk-filebeat01-8.key"
processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
- add_kubernetes_metadata: ~
```

After you start filebeat, it should send logs to logstash

[Back to content list](#content)

## Using Windows CA for certificates
TODO